<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no9">
    <title>Floppy Clicker</title>

    <link rel="stylesheet" href="css/master.css" />
    <link rel="stylesheet" href="css/button.css" />
</head>

<body>

    <div id="canvas"></div>

    <script>
        // Score variable
        var score = 0;

        // Set object assets
        var icon = new Image();
        icon.src = "assets/floppy.png";

        var button = new Image();
        button.src = "assets/test.png";

        class Floppy {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 50;
                this.velocity = 0;
            }

            draw(ctx) {
                ctx.save();

                this.velocity += 1;
                ctx.translate(this.x, this.y += this.velocity);
                ctx.drawImage(icon, 0, 0, this.width, this.height);

                ctx.restore();
            }
        }

        class Counter {
            constructor() {
                this.x = 50;
                this.y = 50;
                this.width = 200;
                this.height = 80;
            }

            draw(ctx) {
                ctx.save();

                ctx.font = "30px Arial";
                ctx.fillStyle = "red";
                ctx.textAlign = "center";
                ctx.fillText(score, this.x, this.y);

                ctx.restore();
            }
        }

        class BigButton {
            constructor(canvasWidth, canvasHeight) {
                this.width = 120;
                this.height = 75;
                this.x = Math.floor(canvasWidth / 2) - Math.floor(this.width / 2);
                this.y = canvasHeight - this.height - 40;
                this.color = "black";
                this.clipping = 0;
            }


            draw(ctx) {
                ctx.save();

                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);

                ctx.restore();
            }

            press() {
                this.color = "green";
                setTimeout(() => {
                    this.color = "black"
                }, 100)

            }
        }

        function main() {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext("2d");

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let canvasWrapper = document.querySelector('#canvas');
            canvasWrapper.appendChild(canvas);


            canvas.addEventListener('click', (e) => {

                for (let i = 0; i < entities.length; i++) {
                    const entity = entities[i];

                    if (entity.constructor.name == 'BigButton') {
                        if (
                            e.clientX - 8 > entity.x &&
                            e.clientX - 8 < entity.x + entity.width &&
                            e.clientY - 8 > entity.y &&
                            e.clientY - 8 < entity.y + entity.height
                        ) {
                            let floppy = new Floppy(Math.random() * canvas.width, Math.random() * 50);
                            entities.push(floppy);
                            score++;
                            saveGame()

                            // Button click animation
                            entity.press(ctx);
                        }
                    }
                }
            })


            let entities = [];

            let bigButton = new BigButton(canvas.width, canvas.height);
            entities.push(bigButton);

            loadGame();


            let floppyCounter = new Counter();
            entities.push(floppyCounter);

            requestAnimationFrame(onProcess);

            function onProcess() {

                // Physics step goes here.

                draw();

                checkRemove();

                requestAnimationFrame(onProcess);

            }

            // Check removal of entity in entities array
            function checkRemove() {
                for (let i = 0; i < entities.length; i++) {
                    let entity = entities[i];

                    if (entity.y >= canvas.height) {
                        entities.splice(i--, 1)
                    }
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw canvas background
                ctx.beginPath();
                ctx.fillStyle = "grey";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                for (let i = 0; i < entities.length; i++) {
                    let entity = entities[i];
                    entity.draw(ctx);
                }

            }

            // Save data score to score. it's easier to keep naming consistent so you need less operations later
            function saveGame() {
                window.localStorage.setItem(
                    'score',
                    JSON.stringify(score)
                );

                console.log(window.localStorage);
            }

            function loadGame() {

                saveData = window.localStorage.getItem('score');

                //  Check if it actually exists otherwise you'll get an error or null value
                if (saveData) {

                    score = JSON.parse(saveData);
                    console.log(saveData);

                }

            }
        }

        main();
    </script>

</body>

</html>